---
layout: post
title: 流量分析
subtitle: 流量分析
date: 2024-08-01 14:04
author: Kyon-H
header-img: img/post-bg-2015.jpg
tags: 
published: false
---
## 1. 攻击者利用 0day 在一台主机上运行了后门程序，请问攻击者攻击载荷休眠时间为多少秒？

过滤流量，添加 `UTC time` 栏，确定本机 `10.1.100.102`，攻击机 `219.24.103.2`

```r
http.request.method == "GET"
```

![image.png](https://img.ghostliner.top/AX7LVH.png)

**分析得到时间间隔为 3 秒**

## 2. 防护人员添加了策略，阻断了 CS 载荷，阻断策略的 ID 是多少？

过滤流量

```r
frame.number > 1953 # 最后一次post请求number为 1953
```

发现 telnet 数据包，过滤分析

```r
telnet && frame.len>60
```

No.3070 发现回显命令：拒绝所有从 10.1.100.0/24 网段发往 219.24.103.2 的 8089 端口的 TCP 数据包

```batch
rule 1265 deny tcp source 10.1.100.0 0.0.0.255 destination 219.24.103.2 0 destination-port eq 8089
```

![image.png](https://img.ghostliner.top/1NOhyt.png)

**策略 ID 为 1265**

相关命令：

```shell
<Huawei>system-view
acl number 3000
rule 1265 deny tcp source 10.1.100.0 0.0.0.255 destination 219.24.103.2 0 destination-port eq 8089
rule 9999 permit ip
return
interface GigabitEthernet0/0/1
ip address 10.1.100.254 255.255.255.0
traffic-filter inbound acl 3000
return
```

## 3. CS 载荷多少次请求没有获取到任务，多少次请求获取到了任务？

查看 http 请求统计信息：
共有 153 次请求，其中 7 次为 post 请求，其余 146 次为 get 请求

![image.png](https://img.ghostliner.top/KjFgHA.png)

过滤 get 请求流量

```r
http.request.method=="GET" && ip.src_host==10.1.100.102 && ip.dst_host==219.24.103.2
```

![image.png](https://img.ghostliner.top/kZcOZU.png)

总共有 146 次 get 请求

```r
ip.addr==10.1.100.102 && ip.addr==219.24.103.2 && http
```

![image.png](https://img.ghostliner.top/of3ACI.png)

无数据包长度为 168，进行过滤

```r
(ip.addr==10.1.100.102 && ip.addr==219.24.103.2 && http) && (frame.len == 168)
```

![image.png](https://img.ghostliner.top/2SGtgO.png)

可知有 137 次未获取到任务

过滤 post 请求有 7 次

![image.png](https://img.ghostliner.top/I9XsPm.png)

**有 137 次未获取到任务，9 次获取到了任务**

## 4. 攻击者被发现以后，使用了什么协议隐藏了自己？

过滤最后一次 get 请求之后的包

```r
frame.number > 3034
```

发现本机和攻击机之间有大量 ICMP 包
![image.png](https://img.ghostliner.top/Qoe8L8.png)

No.3335 中发现明文 Windows 命令行提示信息

![image.png](https://img.ghostliner.top/eUJ7Ku.png)

**攻击者被发现以后，使用了 ICMP 协议隐藏了自己**

## 5. 攻击者在主机新增了一个用户，新增用户所在用户组名就是 flag

过滤无数据包，发现明文数据

```r
((icmp) && !(frame.len == 42)) && !(frame.len == 60)
```

过滤攻击者发送的包

```r
((icmp) && !(frame.len == 42)) && !(frame.len == 60) && ip.src_host==219.24.103.2
```

![image.png](https://img.ghostliner.top/ZEBV7k.png)

No.3447 发现创建用户命令：`net user DPUser Aa123456 /add`

![image.png](https://img.ghostliner.top/P7Ogpo.png)

No.3448 回显命令执行成功
![image.png](https://img.ghostliner.top/HYaLxu.png)

No.3521、No.3727 发现修改用户组命令：`net localgroup DPBackdoor DPUser /add`

![image.png](https://img.ghostliner.top/Ms1djD.png)

No.3522 回显组不存在
![image.png](https://img.ghostliner.top/hAmI1L.png)

No.3728 回显执行成功
![image.png](https://img.ghostliner.top/iKxkuH.png)

**flag**：`DPBackdoor`

相关命令：

```batch
chcp 65001
net user DPUser Aa123456 /add
net localgroup DPBackdoor DPUser /add
net localgroup DPBackdoor /add
net localgroup DPBackdoor DPUser /add
```

## 6. 攻击者在主机添加了计划任务，flag 为 flag{计划任务名}

No.3863 发现计划任务命令

```batch
at 22:00 /every:M,T,W,Th,F,S,Su C:\Windows\System32\icmptunnel.exe
```

![image.png](https://img.ghostliner.top/AVfDyV.png)

No.3864 发现添加计划任务失败

![image.png](https://img.ghostliner.top/bli6WU.png)

No.3932 发现计划任务命令：创建名为“callback”的计划任务，该任务每 10 分钟运行一次 `C:\Windows\System32\icmptunnel.exe`

```batch
schtasks /create /tn "callback" /tr C:\Windows\System32\icmptunnel.exe /sc minute /mo 10
```

![image.png](https://img.ghostliner.top/BqBpXy.png)

No.3933 发现执行成功

![image.png](https://img.ghostliner.top/crBOxU.png)

![image.png](https://img.ghostliner.top/RGNRu5.png)

**flag**: `flag{callback}`

## 7. 受害主机的 RDP 端口是多少，flag 为 flag{RDP 端口}

No.4303 发现命令：将远程桌面服务（RDP）的默认监听端口更改为 22234

```batch
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v PortNumber /t REG_DWORD /d 22234
```

![image.png](https://img.ghostliner.top/Ro4tHx.png)

No.4362 回显命令执行成功

![image.png](https://img.ghostliner.top/hJmBLT.png)

可知受害主机的 RDP 端口是：22234

**flag**：`flag{22234}`

相关命令：

```batch
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0
netstat -ano
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 1
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v PortNumber /t REG_DWORD /d 22234
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0
```
